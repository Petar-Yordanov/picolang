name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang lld \
            llvm-14-dev clang-14 lld-14 \
            libpolly-14-dev \
            make \
            ca-certificates curl \
            libffi-dev \
            zlib1g-dev \
            libtinfo-dev

      - name: Set LLVM_SYS_140_PREFIX
        shell: bash
        run: |
          set -euo pipefail
          echo "LLVM_SYS_140_PREFIX=/usr/lib/llvm-14" >> "$GITHUB_ENV"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build runtime (release)
        run: cargo build -p picolang-runtime --release

      - name: Compile & Run examples/modules (folder mode)
        shell: bash
        env:
          PICOLANG_RUNTIME_LIB_DIR: ${{ github.workspace }}/target/release
        run: |
          set -euo pipefail

          cargo build -p picolang-compiler --release
          cargo run -p picolang-compiler --release -- examples/modules

          CLANG=clang
          command -v clang-14 >/dev/null 2>&1 && CLANG=clang-14

          target="examples/modules"
          if [ -d "$target" ]; then
            entry="$target/main.pico"
          else
            entry="$target"
          fi

          obj="${entry%.pico}.o"
          out="${entry%.pico}"

          if [ ! -f "$obj" ]; then
            echo "Expected object not found: $obj"
            ls -la "$(dirname "$obj")"
            exit 1
          fi

          $CLANG -no-pie "$obj" \
            -L target/release -lpicolang_runtime \
            -o "$out"

          "$out"
          ec=$?
          echo "exit_code=$ec"
          test $ec -eq 0

      - name: Run examples/llvm_tests per-file (must succeed)
        shell: bash
        env:
          PICOLANG_RUNTIME_LIB_DIR: ${{ github.workspace }}/target/release
        run: |
          set -euo pipefail

          CLANG=clang
          command -v clang-14 >/dev/null 2>&1 && CLANG=clang-14

          shopt -s nullglob
          files=(examples/llvm_tests/*.pico)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No .pico files in examples/llvm_tests"
            exit 1
          fi

          for f in "${files[@]}"; do
            dir="$(dirname "$f")"
            base="$(basename "$f" .pico)"
            obj="$dir/$base.o"
            out="$dir/$base"

            echo "== llvm_test: $f =="

            rm -f "$obj" "$out"

            cargo run -p picolang-compiler --release -- "$f"

            if [ ! -f "$obj" ]; then
              echo "Expected object not found: $obj"
              ls -la "$dir"
              exit 1
            fi

            $CLANG -no-pie "$obj" -L target/release -lpicolang_runtime -o "$out"

            "$out"
            ec=$?
            echo "exit_code=$ec"
            test $ec -eq 0
          done

      - name: Run examples/error_modules per-file (must fail)
        shell: bash
        env:
          PICOLANG_RUNTIME_LIB_DIR: ${{ github.workspace }}/target/release
        run: |
          set -euo pipefail

          shopt -s nullglob
          files=(examples/error_modules/*.pico)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No .pico files in examples/error_modules"
            exit 1
          fi

          for f in "${files[@]}"; do
            dir="$(dirname "$f")"
            base="$(basename "$f" .pico)"
            obj="$dir/$base.o"
            out="$dir/$base"

            echo "== error_module: $f =="

            rm -f "$obj" "$out"

            if cargo run -p picolang-compiler --release -- "$f"; then
              echo "Expected compiler failure, but it succeeded: $f"
              exit 1
            else
              echo "Got expected failure: $f"
            fi

            if [ -e "$obj" ] || [ -e "$out" ]; then
              echo "Unexpected outputs produced for an error test: $f"
              ls -la "$dir"
              exit 1
            fi
          done
